// MongoDB Query: Company engagement from workflow_executions
// Run in MongoDB Compass > Aggregations tab on: workflow-server.builder.workflow_executions
// Export to JSON, convert to CSV: data/company_engagement.csv
// 
// OPTIMIZED: Uses compound index type_1_data.company.id_1_data.channel_1_...
// Filtered to 426 SELF_SERVICE companies (excluding test companies)

// SELF_SERVICE company IDs only (342 companies, excluding test companies and jelou)

[
  {
    "$match": {
      "type": "SKILL",
      "data.company.id": { "$in": [2829,2831,2832,2834,2835,2839,2840,2841,2844,2848,2849,2851,2853,2854,2855,2856,2858,2859,2860,2861,2862,2863,2864,2866,2867,2868,2871,2872,2873,2874,2878,2883,2884,2887,2888,2889,2891,2892,2894,2895,2897,2898,2899,2901,2903,2905,2906,2908,2909,2910,2911,2912,2913,2914,2915,2916,2917,2920,2921,2922,2923,2924,2925,2926,2927,2928,2930,2931,2932,2933,2935,2937,2938,2939,2940,2941,2942,2943,2944,2946,2947,2948,2949,2950,2952,2953,2954,2959,2960,2961,2962,2963,2968,2973,2976,2977,2979,2987,2990,2991,2992,2993,2994,2995,2996,2997,2998,3000,3002,3003,3004,3005,3007,3008,3009,3010,3013,3014,3018,3019,3020,3021,3022,3023,3024,3025,3026,3027,3028,3029,3030,3031,3032,3033,3035,3036,3037,3038,3040,3041,3043,3044,3045,3046,3048,3049,3050,3051,3052,3053,3054,3055,3056,3057,3058,3059,3060,3061,3062,3063,3064,3065,3066,3067,3068,3069,3071,3075,3077,3079,3082,3085,3088,3089,3090,3091,3092,3093,3094,3096,3097,3098,3099,3101,3102,3103,3104,3105,3106,3107,3110,3111,3112,3113,3114,3115,3118,3120,3121,3122,3124,3126,3130,3131,3133,3134,3135,3137,3138,3139,3140,3141,3143,3144,3145,3146,3147,3148,3149,3151,3152,3155,3156,3157,3158,3159,3160,3162,3163,3165,3167,3168,3169,3170,3171,3172,3173,3174,3175,3176,3178,3179,3180,3181,3182,3183,3184,3185,3186,3187,3189,3192,3193,3194,3195,3196,3199,3200,3201,3202,3203,3204,3206,3208,3209,3210,3211,3212,3213,3214,3215,3216,3217,3218,3219,3220,3221,3223,3224,3225,3226,3227,3228,3229,3230,3231,3232,3233,3234,3235,3236,3237,3238,3239,3240,3241,3242,3243,3244,3245,3246,3247,3248,3249,3250,3252,3253,3259,3260,3263,3264,3265,3266,3267,3268,3270,3271,3272,3273,3274,3275,3276,3277,3278,3279,3280,3281,3284,3286,3287,3290,3291,3292,3293,3294,3295,3296,3297,3298,3303,3304,3305] },
      "createdAt": { "$gte": ISODate("2025-11-15T00:00:00.000Z") }
    }
  },
  {
    "$group": {
      "_id": "$data.company.id",
      "company_name": { "$first": "$data.company.name" },
      "total_executions": { "$sum": 1 },
      "sandbox_executions": { "$sum": { "$cond": [{ "$eq": ["$isDebug", true] }, 1, 0] } },
      "prod_executions": { "$sum": { "$cond": [{ "$eq": ["$isDebug", false] }, 1, 0] } },
      "whatsapp_executions": { "$sum": { "$cond": [{ "$eq": ["$data.channel", "WHATSAPP"] }, 1, 0] } },
      "web_executions": { "$sum": { "$cond": [{ "$eq": ["$data.channel", "WEB"] }, 1, 0] } },
      "completed": { "$sum": { "$cond": [{ "$eq": ["$status", "COMPLETED"] }, 1, 0] } },
      "failed": { "$sum": { "$cond": [{ "$eq": ["$status", "FAILED"] }, 1, 0] } },
      "unique_workflows": { "$addToSet": "$workflowId" },
      "first_execution": { "$min": "$createdAt" },
      "last_execution": { "$max": "$createdAt" }
    }
  },
  {
    "$project": {
      "_id": 0,
      "company_id": "$_id",
      "company_name": 1,
      "total_executions": 1,
      "sandbox_executions": 1,
      "prod_executions": 1,
      "whatsapp_executions": 1,
      "web_executions": 1,
      "completed": 1,
      "failed": 1,
      "workflow_count": { "$size": "$unique_workflows" },
      "tested_sandbox": { "$gt": ["$sandbox_executions", 0] },
      "went_to_prod": { "$gt": ["$prod_executions", 0] },
      "first_execution": 1,
      "last_execution": 1
    }
  },
  { "$sort": { "total_executions": -1 } }
]

// =====================================================
// OPTION 2: Get workflowId to company mapping (SELF_SERVICE only)
// This links user_activity_logs.workflow_id to companies
// Run on: workflow-server.builder.workflow_executions
// Export to: data/workflow_company_mapping.csv
// =====================================================

[
  {
    "$match": {
      "type": "SKILL",
      "data.company.id": { "$in": [2829,2831,2832,2834,2835,2839,2840,2841,2844,2848,2849,2851,2853,2854,2855,2856,2858,2859,2860,2861,2862,2863,2864,2866,2867,2868,2871,2872,2873,2874,2878,2883,2884,2887,2888,2889,2891,2892,2894,2895,2897,2898,2899,2901,2903,2905,2906,2908,2909,2910,2911,2912,2913,2914,2915,2916,2917,2920,2921,2922,2923,2924,2925,2926,2927,2928,2930,2931,2932,2933,2935,2937,2938,2939,2940,2941,2942,2943,2944,2946,2947,2948,2949,2950,2952,2953,2954,2959,2960,2961,2962,2963,2968,2973,2976,2977,2979,2987,2990,2991,2992,2993,2994,2995,2996,2997,2998,3000,3002,3003,3004,3005,3007,3008,3009,3010,3013,3014,3018,3019,3020,3021,3022,3023,3024,3025,3026,3027,3028,3029,3030,3031,3032,3033,3035,3036,3037,3038,3040,3041,3043,3044,3045,3046,3048,3049,3050,3051,3052,3053,3054,3055,3056,3057,3058,3059,3060,3061,3062,3063,3064,3065,3066,3067,3068,3069,3071,3075,3077,3079,3082,3085,3088,3089,3090,3091,3092,3093,3094,3096,3097,3098,3099,3101,3102,3103,3104,3105,3106,3107,3110,3111,3112,3113,3114,3115,3118,3120,3121,3122,3124,3126,3130,3131,3133,3134,3135,3137,3138,3139,3140,3141,3143,3144,3145,3146,3147,3148,3149,3151,3152,3155,3156,3157,3158,3159,3160,3162,3163,3165,3167,3168,3169,3170,3171,3172,3173,3174,3175,3176,3178,3179,3180,3181,3182,3183,3184,3185,3186,3187,3189,3192,3193,3194,3195,3196,3199,3200,3201,3202,3203,3204,3206,3208,3209,3210,3211,3212,3213,3214,3215,3216,3217,3218,3219,3220,3221,3223,3224,3225,3226,3227,3228,3229,3230,3231,3232,3233,3234,3235,3236,3237,3238,3239,3240,3241,3242,3243,3244,3245,3246,3247,3248,3249,3250,3252,3253,3259,3260,3263,3264,3265,3266,3267,3268,3270,3271,3272,3273,3274,3275,3276,3277,3278,3279,3280,3281,3284,3286,3287,3290,3291,3292,3293,3294,3295,3296,3297,3298,3303,3304,3305] },
      "createdAt": { "$gte": ISODate("2025-11-15T00:00:00.000Z") },
      "workflowId": { "$exists": true }
    }
  },
  {
    "$group": {
      "_id": "$workflowId",
      "company_id": { "$first": "$data.company.id" },
      "company_name": { "$first": "$data.company.name" }
    }
  },
  {
    "$project": {
      "_id": 0,
      "workflow_id": "$_id",
      "company_id": 1,
      "company_name": 1
    }
  },
  { "$sort": { "company_id": 1 } }
]

